# TLS Validation Job
# Tests cross-cluster communication without -k using internal CA

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-validation-script
  namespace: default
  labels:
    aegis.test: tls-validation
data:
  tls-validation.sh: |
    #!/bin/bash
    set -e

    CA_CERT_PATH="/etc/ssl/certs/internal-ca.crt"
    BACKEND_URL="https://backend-api.default.svc.cluster.local/health"

    echo "=== Aegis TLS Validation Test ==="
    echo "Testing TLS connections without -k flag using internal CA"

    # Test with curl using CA certificate
    echo "Testing Backend API Health Check..."
    if response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
                         --cacert "$CA_CERT_PATH" \
                         --connect-timeout 10 \
                         --max-time 30 \
                         "$BACKEND_URL" 2>/dev/null); then

        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_CODE:/d')

        if [ "$http_code" = "200" ]; then
            echo "‚úÖ SUCCESS: HTTP $http_code"
            echo "Response: $body"
            echo "üéâ TLS validation passed!"
            exit 0
        else
            echo "‚ùå FAILED: Expected HTTP 200, got $http_code"
            echo "Response: $body"
            exit 1
        fi
    else
        echo "‚ùå FAILED: Connection error"
        exit 1
    fi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: tls-validation-test
  namespace: default
  labels:
    aegis.test: tls-validation
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
      - name: tls-validator
        image: curlimages/curl:latest
        command:
        - /bin/bash
        - -c
        - |
          # Copy script from ConfigMap
          cp /scripts/tls-validation.sh /tmp/tls-test.sh
          chmod +x /tmp/tls-test.sh

          # Mount CA certificate
          if [ -f /etc/ssl/certs/internal-ca.crt ]; then
            echo "CA certificate found, running TLS test..."
            /tmp/tls-test.sh
          else
            echo "‚ùå CA certificate not found at /etc/ssl/certs/internal-ca.crt"
            echo "Please ensure the internal CA certificate is mounted"
            exit 1
          fi
        volumeMounts:
        - name: tls-script
          mountPath: /scripts
        - name: ca-cert
          mountPath: /etc/ssl/certs
          readOnly: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: tls-script
        configMap:
          name: tls-validation-script
      - name: ca-cert
        secret:
          secretName: internal-root-ca-cert
          items:
          - key: tls.crt
            path: internal-ca.crt
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000